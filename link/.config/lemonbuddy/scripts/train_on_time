#!/bin/bash

logfile="$HOME/.cache/train_on_time.log"

trainId=17761
hour=1730
station="MACON VILLE"

wget -q -O $logfile "http://www.sncf.com/sncf/train?numeroTrain=$trainId&date=$(date +%d/%m/%Y)&heure=$hour&fromRedirect=true&companyCode=SN&equipmentType=TER"

IFS=$'\n'

line_city=$(cat -n $logfile | grep "$station" | awk '{print $1}')
line_hour=$((line_city - 9))
line_on_time=$((line_city + 8))
lines="${line_hour}p;${line_city}p;${line_on_time}p"

text=($(cat $logfile | sed -n "$lines" | sed -e 's/<[^>]*>//g' | awk '{$1=$1};1' | tr -d $'\r'))

if [ -n "${text[2]}" ]
then
	echo "${text[1]} at ${text[0]}: ${text[2]}"

	if [ "${text[2]}" != "On time" ]
	then
		notify-send -u critical "SNCF" "Train en retard !"
	fi
else
	echo "N/A"
fi

