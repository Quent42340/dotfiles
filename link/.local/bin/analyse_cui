#!/bin/bash

# Get the n-th line of file 'f'
getline() {
	cat $1 | head -$2 | tail -1
}

# Get question line number
getq_lineno() {
	line_nos=($(egrep -n "^[0-9]+)" $1 | cut -d: -f1))
	echo ${line_nos[$(($2-1))]}
}

# Get question
getq() {
	IFS=$'\n'
	lines=($(egrep -n "^[0-9]+)" $1 | cut -d')' -f2))
	echo ${lines[$(($2-1))]}
	IFS=$' \t\n'
}

# List answers to a question
list_ans() {
	let line_n="$(getq_lineno $1 $2)"+1
	line="$(getline $1 $line_n)"
	
	while [ "$(echo $line | wc -c)" -gt 2 ]
	do
		echo $line | cut -d'-' -f3
		let line_n++
		line=$(getline $1 $line_n)
	done
}

# Get answers to a question
getq_ans() {
	IFS=$'\n'
	answers=($(list_ans $1 $2))
	echo ${answers[$(($3-1))]}
	IFS=$' \t\n'
}

# Get wrong questions
wrong_question() {
	questions=($(getline $1 20 | sed -e 's/,//g'))
	
	if [ $2 -lt ${#questions[@]} ]
	then
		echo ${questions[$2]}
	else
		echo "0"
	fi
}

# Get my answers
my_ans() {
	answers=($(cat $1))
	echo ${answers[$(($2-1))]} | cut -d: -f2
}

# Get answers
print_all_answers() {
	i=1
	j=0
	while [ $i -le 40 ]
	do
		if [ $i -eq $(wrong_question $3 $j) ]
		then
			let j++
			let i++
			continue
		fi
		
		echo -n "Question $i:"
		getq $1 $i
		
		for ans in $(my_ans $2 $i | sed -e 's/,/ /g')
		do
			echo -n "RÃ©ponse $ans: "
			getq_ans $1 $i $ans
		done

		echo
		
		let i++
	done
}

test

# Analyse folder
analyse_folder() {
	if [ -z $1 ]
	then
		echo "Usage: ./analyse_cui folder"
		exit 1
	fi
	
	if [ -e "$1" -a -e "$1/rendu" -a -e "$1/rendu/subject.txt" -a -e "$1/rendu/reponses.txt" -a -e "$1/trace.txt" ]
	then
		print_all_answers "$1/rendu/subject.txt" "$1/rendu/reponses.txt" "$1/trace.txt"
	else
		echo "Error: Bad folder"
		exit 1
	fi
}

analyse_folder $1

